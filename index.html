<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BUS BELL</title>
<script src="https://api-maps.yandex.ru/2.1/?apikey=43bcf47b-c9da-4b7e-8336-ac41095908e6&lang=ru_RU"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,sans-serif}
body{background:linear-gradient(135deg,#1e3a8a,#3730a3,#6b21a8);min-height:100vh}
.home-screen{display:flex;flex-direction:column;align-items:center;justify-content:space-between;min-height:100vh;padding:40px 20px 0}
.home-top{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center}
.logo{width:120px;height:120px;background:#fff;border-radius:30px;display:flex;align-items:center;justify-content:center;margin-bottom:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);position:relative}
.logo-text{font-size:48px;font-weight:900;background:linear-gradient(135deg,#2563eb,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-bell{position:absolute;top:-5px;right:-5px;font-size:32px;animation:ring 2s infinite}
@keyframes ring{0%,100%{transform:rotate(0)}10%{transform:rotate(15deg)}20%{transform:rotate(-15deg)}30%{transform:rotate(10deg)}40%{transform:rotate(-10deg)}50%{transform:rotate(0)}}
h1{color:#fff;font-size:56px;font-weight:900;margin-bottom:10px}
.subtitle{color:rgba(255,255,255,.9);font-size:20px;margin-bottom:20px}
.location-info{background:rgba(255,255,255,.2);backdrop-filter:blur(10px);padding:15px 30px;border-radius:20px;color:#fff;font-size:16px;margin-bottom:20px;display:none}
.location-info.show{display:block}
.transport-icons{display:flex;gap:30px;justify-content:center;padding:30px;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:30px 30px 0 0;width:100%}
.transport-icon-wrapper{display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;transition:transform .3s}
.transport-icon-wrapper:hover{transform:translateY(-10px)}
.transport-icon-wrapper.disabled{opacity:.4;cursor:not-allowed}
.icon-circle{width:90px;height:90px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:48px;box-shadow:0 10px 30px rgba(0,0,0,.3);transition:all .3s}
.icon-circle.bus{background:linear-gradient(135deg,#3b82f6,#2563eb)}
.icon-circle.train{background:linear-gradient(135deg,#8b5cf6,#7c3aed)}
.icon-circle.metro{background:linear-gradient(135deg,#ef4444,#dc2626)}
.transport-icon-wrapper:hover .icon-circle{box-shadow:0 15px 40px rgba(0,0,0,.4);transform:scale(1.1)}
.transport-icon-wrapper:hover .icon-circle.bus{animation:busMove .5s ease-in-out infinite}
@keyframes busMove{0%,100%{transform:scale(1.1) translateX(0)}50%{transform:scale(1.1) translateX(3px)}}
.icon-label{color:#fff;font-size:14px;font-weight:600}
.icon-sublabel{color:rgba(255,255,255,.7);font-size:12px}
.map-screen{display:none;flex-direction:column;height:100vh}
.map-header{background:#fff;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.header-top{display:flex;align-items:center;gap:15px;margin-bottom:15px}
.back-btn{background:0 0;border:none;font-size:24px;cursor:pointer;color:#666}
.header-title{flex:1}
.header-title h2{font-size:24px;color:#1f2937}
.header-title p{font-size:14px;color:#6b7280}
.search-box{position:relative}
.search-box input{width:100%;padding:15px 15px 15px 45px;border:2px solid #e5e7eb;border-radius:12px;font-size:16px;outline:0}
.search-icon{position:absolute;left:15px;top:50%;transform:translateY(-50%)}
.route-info{margin-top:15px;padding:15px;background:#eff6ff;border:2px solid #93c5fd;border-radius:12px;display:none}
.route-info.show{display:flex}
.route-details{display:flex;gap:15px;flex:1}
.route-number{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
.close-route{background:0 0;border:none;font-size:20px;cursor:pointer}
#map{flex:1}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000}
.modal.show{display:flex}
.modal-content{background:#fff;border-radius:20px;padding:30px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;margin-bottom:20px}
.modal-close{background:0 0;border:none;font-size:24px;cursor:pointer}
.stop-info{padding:20px;background:linear-gradient(135deg,#eff6ff,#f3e8ff);border-radius:12px;margin-bottom:20px}
.stop-details{display:flex;gap:15px}
.stop-route-number{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-weight:600;margin-bottom:10px}
.form-group input{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:16px;outline:0}
.sound-options{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.sound-option{padding:15px;border:2px solid #e5e7eb;border-radius:12px;cursor:pointer;text-align:center}
.sound-option.selected{border-color:#3b82f6;background:#eff6ff}
.sound-option .icon{font-size:32px}
.sound-option .name{font-size:14px;font-weight:600}
.create-btn{width:100%;padding:15px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff;border:none;border-radius:12px;font-size:18px;font-weight:700;cursor:pointer}
.radius-note{text-align:center;color:#6b7280;font-size:12px;margin-top:10px}
</style>
</head>
<body>
<div id="homeScreen" class="home-screen">
<div class="home-top">
<div class="logo"><div class="logo-text">BB</div><div class="logo-bell">üîî</div></div>
<h1>BUS BELL</h1>
<p class="subtitle">–ù–µ –ø—Ä–æ—Å–ø–∏ —Å–≤–æ—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É</p>
<div id="locationInfo" class="location-info"><span>üìç</span><span id="cityName">–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...</span></div>
</div>
<div class="transport-icons">
<div class="transport-icon-wrapper" onclick="selectTransport()">
<div class="icon-circle bus">üöå</div>
<div class="icon-label">–ê–≤—Ç–æ–±—É—Å—ã</div>
<div class="icon-sublabel">2 –º–∞—Ä—à—Ä—É—Ç–æ–≤</div>
</div>
<div class="transport-icon-wrapper disabled">
<div class="icon-circle train">üöÜ</div>
<div class="icon-label">–≠–ª–µ–∫—Ç—Ä–∏—á–∫–∏</div>
<div class="icon-sublabel">–°–∫–æ—Ä–æ</div>
</div>
<div class="transport-icon-wrapper disabled">
<div class="icon-circle metro">üöá</div>
<div class="icon-label">–ú–µ—Ç—Ä–æ</div>
<div class="icon-sublabel">–°–∫–æ—Ä–æ</div>
</div>
</div>
</div>
<div id="mapScreen" class="map-screen">
<div class="map-header">
<div class="header-top">
<button class="back-btn" onclick="goHome()">‚úï</button>
<div class="header-title"><h2>üöå –ê–≤—Ç–æ–±—É—Å—ã</h2><p id="cityMap">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä ‚Ä¢ 2 –º–∞—Ä—à—Ä—É—Ç–æ–≤</p></div>
</div>
<div class="search-box"><span class="search-icon">üîç</span><input id="searchInput" placeholder="–ü–æ–∏—Å–∫ (177, 7–∞)" oninput="searchRoute(this.value)"></div>
<div id="routeInfo" class="route-info">
<div class="route-details"><div class="route-number" id="routeNumber"></div><div><h4 id="routeName"></h4><p id="routeStops"></p></div></div>
<button class="close-route" onclick="clearRoute()">‚úï</button>
</div>
</div>
<div id="map"></div>
</div>
<div id="alertModal" class="modal">
<div class="modal-content">
<div class="modal-header"><h3>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>
<div class="stop-info"><div class="stop-details"><div class="stop-route-number" id="modalRouteNumber"></div><div><h4 id="modalStopName"></h4><p id="modalRouteName"></p></div></div></div>
<div class="form-group"><label>–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</label><input id="alertText" placeholder="–í—ã–π—Ç–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π!"></div>
<div class="form-group"><label>–ó–≤—É–∫</label>
<div class="sound-options">
<div class="sound-option selected" onclick="selectSound('bell')"><div class="icon">üîî</div><div class="name">–ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫</div></div>
<div class="sound-option" onclick="selectSound('alarm')"><div class="icon">‚è∞</div><div class="name">–ë—É–¥–∏–ª—å–Ω–∏–∫</div></div>
<div class="sound-option" onclick="selectSound('chime')"><div class="icon">üéµ</div><div class="name">–ó–≤–æ–Ω–æ–∫</div></div>
<div class="sound-option" onclick="selectSound('beep')"><div class="icon">üì¢</div><div class="name">–°–∏–≥–Ω–∞–ª</div></div>
</div>
</div>
<button class="create-btn" onclick="createAlert()">üîî –°–æ–∑–¥–∞—Ç—å</button>
<p class="radius-note">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 500–º</p>
</div>
</div>
<script>
let map,selectedStop,selectedRoute,selectedSound='bell',activeAlerts=[],userLocationMarker,watchId,userCity='–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä';

// –ú–∞—Ä—à—Ä—É—Ç 177: –ú–ï–ì–ê - –ù–µ–≤–∫–∏–ø–µ–ª–æ–≥–æ (—Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª—é—á–µ–≤—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫)
// –ú–∞—Ä—à—Ä—É—Ç 7–ê: –ú–ï–ì–ê - –∞—É–ª –ù–æ–≤–∞—è –ê–¥—ã–≥–µ—è (—Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
const routes={bus:[
{id:1,number:'177',name:'–ú–ï–ì–ê - –ù–µ–≤–∫–∏–ø–µ–ª–æ–≥–æ',color:'#dc2626',stops:[
{id:1,name:'–°–ë–° –ú–µ–≥–∞–º–æ–ª–ª',coords:[45.0370,39.0805]},
{id:2,name:'–®–∫–æ–ª–∞',coords:[45.0340,39.0650]},
{id:3,name:'—Å—Ç. –Ø–±–ª–æ–Ω–æ–≤—Å–∫–∞—è',coords:[45.0320,39.0450]},
{id:4,name:'–ü–µ—Ä–µ–ø—Ä–∞–≤–Ω—ã–π –ø–µ—Ä–µ—É–ª–æ–∫',coords:[45.0310,39.0350]},
{id:5,name:'–ó–∞–≤–æ–¥ –°–µ–¥–∏–Ω–∞',coords:[45.0295,39.0250]},
{id:6,name:'—É–ª. –ö–ò–ú',coords:[45.0280,39.0150]},
{id:7,name:'—É–ª. –í–∏—à–Ω—è–∫–æ–≤–æ–π',coords:[45.0265,39.0050]},
{id:8,name:'–ü–∞—à–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ—É–ª–æ–∫',coords:[45.0250,38.9950]},
{id:9,name:'—É–ª. –ü–∞–≤–ª–æ–≤–∞',coords:[45.0235,38.9850]},
{id:10,name:'–°—Ç–∞—Ä–æ–∫—É–±–∞–Ω—Å–∫–∞—è',coords:[45.0220,38.9750]},
{id:11,name:'–¢–≠–¶',coords:[45.0200,38.9650]},
{id:12,name:'–ü–∞—Ä–∫ –°–æ–ª–Ω–µ—á–Ω—ã–π –æ—Å—Ç—Ä–æ–≤',coords:[45.0360,38.9920]},
{id:13,name:'–°—Ç–∞–¥–∏–æ–Ω',coords:[45.0355,38.9750]},
{id:14,name:'—É–ª. –ù–µ–≤–∫–∏–ø–µ–ª–æ–≥–æ',coords:[45.0300,39.0100]}
]},
{id:2,number:'7–ê',name:'–ú–ï–ì–ê - –∞—É–ª –ù–æ–≤–∞—è –ê–¥—ã–≥–µ—è',color:'#16a34a',stops:[
{id:15,name:'–°–ë–° –ú–µ–≥–∞–º–æ–ª–ª',coords:[45.0370,39.0805]},
{id:16,name:'–®–∫–æ–ª–∞',coords:[45.0340,39.0650]},
{id:17,name:'–ñ–ö –°–æ–ª–Ω–µ—á–Ω—ã–π',coords:[45.0330,39.0550]},
{id:18,name:'–ü–ª–∞—Å—Ç–∏–∫ –¢—Ä–µ–π–¥',coords:[45.0320,39.0480]},
{id:19,name:'–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞',coords:[45.0315,39.0420]},
{id:20,name:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ø–±–ª–æ–Ω–æ–≤—Å–∫–∏–π',coords:[45.0310,39.0380]},
{id:21,name:'–ö–æ–Ω—Å–µ—Ä–≤–Ω—ã–π –∫–æ–º–±–∏–Ω–∞—Ç',coords:[45.0300,39.0300]},
{id:22,name:'–ó–∞–≤–æ–¥ –°–µ–¥–∏–Ω–∞',coords:[45.0295,39.0250]},
{id:23,name:'–ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ä—ã–Ω–æ–∫',coords:[45.0285,39.0200]},
{id:24,name:'–∞—É–ª –ù–æ–≤–∞—è –ê–¥—ã–≥–µ—è',coords:[45.0270,39.0150]}
]}
]};

window.onload=()=>{
if(navigator.geolocation){
navigator.geolocation.getCurrentPosition(pos=>{
const c=[pos.coords.latitude,pos.coords.longitude];
ymaps.ready(()=>{
ymaps.geocode(c).then(res=>{
const city=res.geoObjects.get(0).getLocalities()[0]||res.geoObjects.get(0).getAdministrativeAreas()[0]||'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä';
userCity=city;
document.getElementById('cityName').textContent=`–í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –≥–æ—Ä–æ–¥–µ ${city}`;
document.getElementById('cityMap').textContent=`${city} ‚Ä¢ 2 –º–∞—Ä—à—Ä—É—Ç–æ–≤`;
document.getElementById('locationInfo').classList.add('show');
});
});
},()=>{
document.getElementById('cityName').textContent='–í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –≥–æ—Ä–æ–¥–µ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä';
document.getElementById('locationInfo').classList.add('show');
});
}else{
document.getElementById('cityName').textContent='–í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –≥–æ—Ä–æ–¥–µ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä';
document.getElementById('locationInfo').classList.add('show');
}
};

function selectTransport(){
document.getElementById('homeScreen').style.display='none';
document.getElementById('mapScreen').style.display='flex';
initMap();
}

function goHome(){
document.getElementById('mapScreen').style.display='none';
document.getElementById('homeScreen').style.display='flex';
if(watchId)navigator.geolocation.clearWatch(watchId);
}

function initMap(){
ymaps.ready(()=>{
map=new ymaps.Map('map',{center:[45.0320,39.0400],zoom:13,controls:['zoomControl','geolocationControl']});

routes.bus.forEach(route=>{
const poly=new ymaps.Polyline(route.stops.map(s=>s.coords),{},{strokeColor:route.color,strokeWidth:6,strokeOpacity:0.8});
map.geoObjects.add(poly);

route.stops.forEach((stop,idx)=>{
const p=new ymaps.Placemark(stop.coords,{
balloonContent:`<strong>${stop.name}</strong><br>–ú–∞—Ä—à—Ä—É—Ç ${route.number}: ${route.name}<br>–û—Å—Ç–∞–Ω–æ–≤–∫–∞ ${idx+1} –∏–∑ ${route.stops.length}`,
hintContent:stop.name
},{
preset:'islands#circleIcon',
iconColor:route.color
});
p.events.add('click',()=>openAlertModal(stop,route));
map.geoObjects.add(p);
});
});

startTracking();
});
}

function startTracking(){
if(navigator.geolocation){
watchId=navigator.geolocation.watchPosition(pos=>{
const c=[pos.coords.latitude,pos.coords.longitude];
if(userLocationMarker)map.geoObjects.remove(userLocationMarker);
userLocationMarker=new ymaps.Placemark(c,{balloonContent:'–í—ã –∑–¥–µ—Å—å'},{preset:'islands#blueDotIcon'});
map.geoObjects.add(userLocationMarker);

activeAlerts.forEach(a=>{
if(!a.triggered){
const R=6371e3;
const p1=c[0]*Math.PI/180,p2=a.stop.coords[0]*Math.PI/180;
const dp=(a.stop.coords[0]-c[0])*Math.PI/180,dl=(a.stop.coords[1]-c[1])*Math.PI/180;
const aa=Math.sin(dp/2)*Math.sin(dp/2)+Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)*Math.sin(dl/2);
const d=R*2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));
if(d<500){
playSound(a.sound);
if('vibrate'in navigator)navigator.vibrate([200,100,200,100,200]);
if(Notification.permission==='granted')new Notification('üîî BUS BELL',{body:a.text||`–û—Å—Ç–∞–Ω–æ–≤–∫–∞ "${a.stop.name}" —á–µ—Ä–µ–∑ 500–º`});
a.triggered=true;
alert(`üîî BUS BELL\n\n${a.text||`–û—Å—Ç–∞–Ω–æ–≤–∫–∞ "${a.stop.name}" —á–µ—Ä–µ–∑ 500–º!`}\n\n–ú–∞—Ä—à—Ä—É—Ç ${a.route.number}`);
}
}
});
},e=>console.error(e),{enableHighAccuracy:true,maximumAge:0});
if(Notification.permission==='default')Notification.requestPermission();
}
}

function playSound(s){
const ctx=new(window.AudioContext||window.webkitAudioContext)();
const f={bell:[800,600],alarm:[1000,800,1000],chime:[523,659,784],beep:[1200,1200]}[s];
f.forEach((fr,i)=>{
const o=ctx.createOscillator(),g=ctx.createGain();
o.connect(g);g.connect(ctx.destination);
o.frequency.value=fr;o.type='sine';
g.gain.setValueAtTime(0.4,ctx.currentTime+i*0.3);
g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+i*0.3+0.5);
o.start(ctx.currentTime+i*0.3);o.stop(ctx.currentTime+i*0.3+0.5);
});
}

function searchRoute(q){
if(!q){clearRoute();return;}
const f=routes.bus.find(r=>r.number.toLowerCase().includes(q.toLowerCase()));
if(f){
document.getElementById('routeInfo').classList.add('show');
document.getElementById('routeNumber').style.backgroundColor=f.color;
document.getElementById('routeNumber').textContent=f.number;
document.getElementById('routeName').textContent=f.name;
document.getElementById('routeStops').textContent=`${f.stops.length} –æ—Å—Ç–∞–Ω–æ–≤–æ–∫`;
map.setBounds(f.stops.map(s=>s.coords),{checkZoomRange:true,zoomMargin:50});
}else clearRoute();
}

function clearRoute(){
document.getElementById('routeInfo').classList.remove('show');
document.getElementById('searchInput').value='';
}

function openAlertModal(s,r){
selectedStop=s;selectedRoute=r;
document.getElementById('modalRouteNumber').style.backgroundColor=r.color;
document.getElementById('modalRouteNumber').textContent=r.number;
document.getElementById('modalStopName').textContent=s.name;
document.getElementById('modalRouteName').textContent=`–ú–∞—Ä—à—Ä—É—Ç ${r.number}: ${r.name}`;
document.getElementById('alertText').value='';
document.getElementById('alertModal').classList.add('show');
}

function closeModal(){
document.getElementById('alertModal').classList.remove('show');
}

function selectSound(s){
selectedSound=s;
document.querySelectorAll('.sound-option').forEach(e=>e.classList.remove('selected'));
event.target.closest('.sound-option').classList.add('selected');
}

function createAlert(){
const t=document.getElementById('alertText').value;
activeAlerts.push({
id:Date.now(),
stop:selectedStop,
route:selectedRoute,
text:t,
sound:selectedSound,
triggered:false
});
closeModal();
alert(`‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!\n\n–û—Å—Ç–∞–Ω–æ–≤–∫–∞: ${selectedStop.name}\n–ú–∞—Ä—à—Ä—É—Ç ${selectedRoute.number}\n\n–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 500 –º–µ—Ç—Ä–æ–≤`);
}
</script>
</body>
</html>
